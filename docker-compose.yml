version: '3.9'
services:
  # 1. Base de Datos (PostgreSQL)
  db:
    image: postgres:15-alpine
    container_name: postgres_db
    environment:
      POSTGRES_DB: proyectos_tecsup
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 7630
    ports:
      - "5432:5432"
    volumes:
      # Persistencia de datos (para que la data no se pierda al apagar el contenedor)
      - postgres_data:/var/lib/postgresql/data
  
  # 2. Backend de Java (Spring Boot)
  backend-java:
    build: 
      context: ./tecsup_proyectos # Ruta al Dockerfile
    container_name: backend_springboot
    ports:
      - "8080:8080"
    environment:
      # CR√çTICO: Conexi√≥n a la DB usando el nombre del servicio 'db'
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/proyectos_tecsup
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: 7630
      # Stripe secret key (test)
      # Stripe test key should not be committed. Use environment variable or Docker secrets in CI.
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-"<replace-with-test-key-in-env>"}
    depends_on:
      - db # Esperar a que la DB est√© lista

  # 3. Backend de Python (Django)
  backend-python:
    build: 
      context: ./empresariales
    container_name: backend_django
    ports:
      - "8000:8000"
    # üö® CR√çTICO: Usar el script de entrada en lugar del comando simple
    command: /bin/sh -c "python manage.py migrate --noinput && python manage.py runserver 0.0.0.0:8000"
    # Nota: Si el script entrypoint.sh no funciona, usaremos este comando simple
    # El uso de 'command' aqu√≠ intenta correr migrate y luego runserver.
    environment:
      # CR√çTICO: Conexi√≥n a la DB usando el nombre del servicio 'db'
      DATABASE_URL: postgres://postgres:7630@db:5432/proyectos_tecsup
    depends_on:
      - db # Esperar a que la DB est√© lista

  # 4. Frontend (Vite/React)
  frontend:
    build: 
      context: ./frontend # Ruta al Dockerfile
    container_name: frontend_vite
    ports:
      # Mapea puerto 80 (HTTP)
      - "5173:80"
    depends_on:
      - backend-java
      - backend-python
    environment:
      STRIPE_PUBLISHABLE_KEY: pk_test_51SZE8z0O6jtgklFz8a8b06o9pOp9fHT5lBJ7N1cKrVmsJllpBLR9DssG0onQgnrhANJQoO8xMlArnQRQoBzOhis400aUHu70We
      
volumes:
  postgres_data: